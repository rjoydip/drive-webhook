{
	"info": {
		"name": "Drive Webhook API",
		"description": "Complete API collection for Google Drive Webhook integration with OAuth2 authentication, webhook management, and change tracking.",
		"schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json",
		"version": "1.0.0"
	},
	"auth": {
		"type": "bearer",
		"bearer": [
			{
				"key": "token",
				"value": "{{WEBHOOK_AUTH_CLIENT_KEY}}",
				"type": "string"
			}
		]
	},
	"variable": [
		{
			"key": "baseUrl",
			"value": "https://your-worker.workers.dev",
			"type": "string"
		},
		{
			"key": "WEBHOOK_AUTH_CLIENT_KEY",
			"value": "your_auth_key_here",
			"type": "string"
		},
		{
			"key": "google_client_id",
			"value": "your_google_client_id",
			"type": "string"
		},
		{
			"key": "google_client_secret",
			"value": "your_google_client_secret",
			"type": "string"
		},
		{
			"key": "google_auth_code",
			"value": "",
			"type": "string"
		},
		{
			"key": "google_access_token",
			"value": "",
			"type": "string"
		},
		{
			"key": "google_refresh_token",
			"value": "",
			"type": "string"
		},
		{
			"key": "google_drive_start_page_token",
			"value": "",
			"type": "string"
		},
		{
			"key": "google_drive_folder_id",
			"value": "",
			"type": "string"
		},
		{
			"key": "worker_drive_webhook_url",
			"value": "https://your-worker.workers.dev/drive/webhook",
			"type": "string"
		}
	],
	"item": [
		{
			"name": "Health & Status",
			"item": [
				{
					"name": "Root Endpoint",
					"request": {
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{baseUrl}}/",
							"host": ["{{baseUrl}}"],
							"path": [""]
						},
						"description": "Welcome endpoint that returns basic status information."
					},
					"response": [
						{
							"name": "Success Response",
							"originalRequest": {
								"method": "GET",
								"url": "{{baseUrl}}/"
							},
							"status": "OK",
							"code": 200,
							"_postman_previewlanguage": "json",
							"header": [
								{
									"key": "Content-Type",
									"value": "application/json"
								}
							],
							"body": "{\n  \"status\": \"Welcome to Drive Webhook\",\n  \"timestamp\": 1234567890\n}"
						}
					]
				},
				{
					"name": "Health Check",
					"request": {
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{baseUrl}}/health",
							"host": ["{{baseUrl}}"],
							"path": ["health"]
						},
						"description": "Health check endpoint to verify the service is running."
					},
					"response": [
						{
							"name": "Health OK",
							"originalRequest": {
								"method": "GET",
								"url": "{{baseUrl}}/health"
							},
							"status": "OK",
							"code": 200,
							"_postman_previewlanguage": "json",
							"body": "{\n  \"status\": \"OK\",\n  \"timestamp\": 1234567890\n}"
						}
					]
				}
			],
			"description": "Endpoints for checking service health and status."
		},
		{
			"name": "OAuth Flow",
			"item": [
				{
					"name": "1. Generate OAuth URL",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"if (pm.response.code === 200) {",
									"    const response = pm.response.json();",
									"    console.log('OAuth URL:', response.auth_url);",
									"    console.log('Copy this URL and paste it in your browser to authorize');",
									"}"
								]
							}
						}
					],
					"request": {
						"auth": {
							"type": "bearer",
							"bearer": [
								{
									"key": "token",
									"value": "{{WEBHOOK_AUTH_CLIENT_KEY}}",
									"type": "string"
								}
							]
						},
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"client_id\": \"{{google_client_id}}\",\n  \"client_secret\": \"{{google_client_secret}}\",\n  \"redirect_uris\": [\n    \"{{baseUrl}}/oauth/callback\"\n  ]\n}"
						},
						"url": {
							"raw": "{{baseUrl}}/oauth/url",
							"host": ["{{baseUrl}}"],
							"path": ["oauth", "url"]
						},
						"description": "Generates Google OAuth consent URL. Copy the returned URL and open it in your browser to authorize the application."
					},
					"response": [
						{
							"name": "OAuth URL Generated",
							"originalRequest": {
								"method": "POST",
								"url": "{{baseUrl}}/oauth/url"
							},
							"status": "OK",
							"code": 200,
							"_postman_previewlanguage": "json",
							"body": "{\n  \"auth_url\": \"https://accounts.google.com/o/oauth2/auth?...\",\n  \"message\": \"ðŸ”— Use this URL to authorize the application\"\n}"
						}
					]
				},
				{
					"name": "2. OAuth Callback (Manual)",
					"request": {
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{baseUrl}}/oauth/callback?code={{google_auth_code}}",
							"host": ["{{baseUrl}}"],
							"path": ["oauth", "callback"],
							"query": [
								{
									"key": "code",
									"value": "{{google_auth_code}}",
									"description": "OAuth2 code from Google redirect"
								}
							]
						},
						"description": "This endpoint is called by Google after user authorization. Typically handled automatically in browser, but can be called manually for testing."
					},
					"response": [
						{
							"name": "Code Stored",
							"originalRequest": {
								"method": "GET",
								"url": "{{baseUrl}}/oauth/callback?code=sample_code"
							},
							"status": "OK",
							"code": 200,
							"_postman_previewlanguage": "json",
							"body": "{\n  \"message\": \"âœ… OAuth2 code stored. You can close this tab.\",\n  \"google_auth_code\": \"sample_code\"\n}"
						}
					]
				},
				{
					"name": "3. Exchange Auth Code for Tokens",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"if (pm.response.code === 200) {",
									"    const response = pm.response.json();",
									"    pm.collectionVariables.set('google_access_token', response.accessToken);",
									"    pm.collectionVariables.set('google_refresh_token', response.refreshToken);",
									"    console.log('âœ… Tokens saved to collection variables');",
									"}"
								]
							}
						}
					],
					"request": {
						"auth": {
							"type": "bearer",
							"bearer": [
								{
									"key": "token",
									"value": "{{WEBHOOK_AUTH_CLIENT_KEY}}",
									"type": "string"
								}
							]
						},
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"google_auth_code\": \"{{google_auth_code}}\"\n}"
						},
						"url": {
							"raw": "{{baseUrl}}/oauth/exchange",
							"host": ["{{baseUrl}}"],
							"path": ["oauth", "exchange"]
						},
						"description": "Exchanges the OAuth code for access and refresh tokens. Updates collection variables automatically."
					},
					"response": [
						{
							"name": "Tokens Received",
							"originalRequest": {
								"method": "POST",
								"url": "{{baseUrl}}/oauth/exchange"
							},
							"status": "OK",
							"code": 200,
							"_postman_previewlanguage": "json",
							"body": "{\n  \"message\": \"Token exchange successful\",\n  \"accessToken\": \"ya29.a0...\",\n  \"refreshToken\": \"1//0g...\",\n  \"expiry_date\": 1234567890\n}"
						}
					]
				}
			],
			"description": "OAuth 2.0 authentication flow for Google Drive API access.",
			"event": [
				{
					"listen": "prerequest",
					"script": {
						"type": "text/javascript",
						"exec": [""]
					}
				}
			]
		},
		{
			"name": "Drive Setup",
			"item": [
				{
					"name": "1. Get Start Page Token",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"if (pm.response.code === 200) {",
									"    const response = pm.response.json();",
									"    pm.collectionVariables.set('google_drive_start_page_token', response.google_drive_start_page_token);",
									"    console.log('âœ… Start page token saved:', response.google_drive_start_page_token);",
									"}"
								]
							}
						}
					],
					"request": {
						"auth": {
							"type": "bearer",
							"bearer": [
								{
									"key": "token",
									"value": "{{WEBHOOK_AUTH_CLIENT_KEY}}",
									"type": "string"
								}
							]
						},
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"google_access_token\": \"{{google_access_token}}\"\n}"
						},
						"url": {
							"raw": "{{baseUrl}}/drive/startPageToken",
							"host": ["{{baseUrl}}"],
							"path": ["drive", "startPageToken"]
						},
						"description": "Initializes Google Drive change tracking by fetching the start page token. This is required before setting up webhooks."
					},
					"response": [
						{
							"name": "Token Retrieved",
							"originalRequest": {
								"method": "POST",
								"url": "{{baseUrl}}/drive/startPageToken"
							},
							"status": "OK",
							"code": 200,
							"_postman_previewlanguage": "json",
							"body": "{\n  \"message\": \"Drive change tracking initialized\",\n  \"google_drive_start_page_token\": \"12345\"\n}"
						}
					]
				},
				{
					"name": "2. Create Watch Channel",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"if (pm.response.code === 200) {",
									"    const response = pm.response.json();",
									"    console.log('âœ… Watch channel created');",
									"    console.log('Channel ID:', response.channelId);",
									"    console.log('Resource ID:', response.resourceId);",
									"    console.log('Expiration:', new Date(response.expiration));",
									"}"
								]
							}
						}
					],
					"request": {
						"auth": {
							"type": "bearer",
							"bearer": [
								{
									"key": "token",
									"value": "{{WEBHOOK_AUTH_CLIENT_KEY}}",
									"type": "string"
								}
							]
						},
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"google_access_token\": \"{{google_access_token}}\",\n  \"google_drive_start_page_token\": \"{{google_drive_start_page_token}}\",\n  \"worker_drive_webhook_url\": \"{{worker_drive_webhook_url}}\"\n}"
						},
						"url": {
							"raw": "{{baseUrl}}/drive/watch",
							"host": ["{{baseUrl}}"],
							"path": ["drive", "watch"]
						},
						"description": "Creates a watch channel for Google Drive changes. The channel expires after 24 hours and needs to be renewed."
					},
					"response": [
						{
							"name": "Channel Created",
							"originalRequest": {
								"method": "POST",
								"url": "{{baseUrl}}/drive/watch"
							},
							"status": "OK",
							"code": 200,
							"_postman_previewlanguage": "json",
							"body": "{\n  \"message\": \"Drive watch channel created\",\n  \"channelId\": \"550e8400-e29b-41d4-a716-446655440000\",\n  \"resourceId\": \"abcd1234\",\n  \"expiration\": 1234567890000,\n  \"webhookToken\": \"550e8400-e29b-41d4-a716-446655440001\"\n}"
						}
					]
				}
			],
			"description": "Setup endpoints for Google Drive webhook integration."
		},
		{
			"name": "Drive Operations",
			"item": [
				{
					"name": "Download Changed File",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"if (pm.response.code === 200) {",
									"    console.log('âœ… File downloaded successfully');",
									"    console.log('Content-Type:', pm.response.headers.get('Content-Type'));",
									"    console.log('Content-Disposition:', pm.response.headers.get('Content-Disposition'));",
									"}"
								]
							}
						}
					],
					"request": {
						"auth": {
							"type": "bearer",
							"bearer": [
								{
									"key": "token",
									"value": "{{WEBHOOK_AUTH_CLIENT_KEY}}",
									"type": "string"
								}
							]
						},
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"google_access_token\": \"{{google_access_token}}\",\n  \"file_name\": \"document.pdf\",\n  \"google_drive_start_page_token\": \"{{google_drive_start_page_token}}\"\n}"
						},
						"url": {
							"raw": "{{baseUrl}}/drive/download",
							"host": ["{{baseUrl}}"],
							"path": ["drive", "download"]
						},
						"description": "Downloads a specific file from recent Drive changes by filtering with the file name."
					},
					"response": [
						{
							"name": "File Downloaded",
							"originalRequest": {
								"method": "POST",
								"url": "{{baseUrl}}/drive/download"
							},
							"status": "OK",
							"code": 200,
							"_postman_previewlanguage": "binary",
							"header": [
								{
									"key": "Content-Type",
									"value": "application/pdf"
								},
								{
									"key": "Content-Disposition",
									"value": "attachment; filename=\"document.pdf\""
								}
							],
							"body": "<binary file content>"
						},
						{
							"name": "File Not Found",
							"originalRequest": {
								"method": "POST",
								"url": "{{baseUrl}}/drive/download"
							},
							"status": "Not Found",
							"code": 404,
							"_postman_previewlanguage": "json",
							"body": "{\n  \"message\": \"File not found in recent changes\"\n}"
						},
						{
							"name": "Missing Fields",
							"originalRequest": {
								"method": "POST",
								"url": "{{baseUrl}}/drive/download"
							},
							"status": "Bad Request",
							"code": 400,
							"_postman_previewlanguage": "json",
							"body": "{\n  \"message\": \"Validation error\"\n}"
						}
					]
				}
			],
			"description": "Endpoints for Google Drive file operations."
		},
		{
			"name": "Webhook Events",
			"item": [
				{
					"name": "Drive Webhook Handler",
					"request": {
						"auth": {
							"type": "bearer",
							"bearer": [
								{
									"key": "token",
									"value": "{{WEBHOOK_AUTH_CLIENT_KEY}}",
									"type": "string"
								}
							]
						},
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							},
							{
								"key": "X-Goog-Resource-State",
								"value": "change",
								"description": "Can be 'sync' or 'change'"
							},
							{
								"key": "X-Goog-Channel-Token",
								"value": "your_webhook_token",
								"description": "Token from watch channel creation"
							},
							{
								"key": "X-Goog-Resource-ID",
								"value": "resource_id",
								"description": "Resource ID from Google"
							},
							{
								"key": "X-Goog-Channel-ID",
								"value": "channel_id",
								"description": "Channel ID from watch channel creation"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"google_drive_folder_id\": \"{{google_drive_folder_id}}\",\n  \"google_access_token\": \"{{google_access_token}}\",\n  \"google_drive_start_page_token\": \"{{google_drive_start_page_token}}\"\n}"
						},
						"url": {
							"raw": "{{baseUrl}}/drive/webhook",
							"host": ["{{baseUrl}}"],
							"path": ["drive", "webhook"]
						},
						"description": "Handles incoming webhook notifications from Google Drive. Google calls this endpoint when changes occur in the watched Drive folder."
					},
					"response": [
						{
							"name": "Sync Event",
							"originalRequest": {
								"method": "POST",
								"url": "{{baseUrl}}/drive/webhook"
							},
							"status": "OK",
							"code": 200,
							"_postman_previewlanguage": "json",
							"body": "{\n  \"message\": \"Sync acknowledged\",\n  \"state\": \"sync\"\n}"
						},
						{
							"name": "Change Event",
							"originalRequest": {
								"method": "POST",
								"url": "{{baseUrl}}/drive/webhook"
							},
							"status": "OK",
							"code": 200,
							"_postman_previewlanguage": "json",
							"body": "{\n  \"message\": \"Change processed\",\n  \"result\": {\n    \"changes\": []\n  }\n}"
						},
						{
							"name": "Unauthorized",
							"originalRequest": {
								"method": "POST",
								"url": "{{baseUrl}}/drive/webhook"
							},
							"status": "Unauthorized",
							"code": 401,
							"_postman_previewlanguage": "json",
							"body": "{\n  \"message\": \"Unauthorized webhook\"\n}"
						}
					]
				}
			],
			"description": "Webhook handler endpoints called by external services (Google Drive)."
		},
		{
			"name": "Monitoring",
			"item": [
				{
					"name": "Wrangler Tail Stream",
					"request": {
						"auth": {
							"type": "bearer",
							"bearer": [
								{
									"key": "token",
									"value": "{{WEBHOOK_AUTH_CLIENT_KEY}}",
									"type": "string"
								}
							]
						},
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{baseUrl}}/wrangler/tail",
							"host": ["{{baseUrl}}"],
							"path": ["wrangler", "tail"]
						},
						"description": "Streams real-time logs from Cloudflare Workers. Returns a Server-Sent Events stream."
					},
					"response": []
				}
			],
			"description": "Monitoring and logging endpoints."
		}
	],
	"event": [
		{
			"listen": "prerequest",
			"script": {
				"type": "text/javascript",
				"exec": ["// Global pre-request script", "// Add any global setup here"]
			}
		},
		{
			"listen": "test",
			"script": {
				"type": "text/javascript",
				"exec": [
					"// Global test script",
					"pm.test('Status code is successful', function () {",
					"    pm.expect(pm.response.code).to.be.oneOf([200, 201, 204]);",
					"});"
				]
			}
		}
	]
}
